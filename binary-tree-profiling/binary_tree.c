#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>
#include <getopt.h>

#include "debug.h"
#include "cmdline.h"


#ifdef BDWGC
#include "gc.h"
#include "gc/gc_mark.h"
#define MYMALLOC(_sz) GC_MALLOC(_sz)
#define FREE(_ptr) 
#else
#include <stdlib.h>
#define MYMALLOC(_sz) malloc(_sz)
#define FREE(_ptr) free(_ptr)
#endif

#if defined(BM_LOGFILE)
# include "bench_harness.h"
# include <time.h>
#endif

#if defined(BDWGC)
unsigned int GC_count = 0; 
unsigned cum_mark_time_ms = 0; 
unsigned cum_mark_time_ns = 0; 
unsigned int mark_start_no = 0;
unsigned int mark_end_no = 0; 

static void signal_gc() 
{
  GC_count++; 
}

# define CLIENT_MS_TIME_DIFF(a,b) (CLOCKS_PER_SEC % 1000 == 0 ? \
        (unsigned long)((a) - (b)) / (unsigned long)(CLOCKS_PER_SEC / 1000) \
        : ((unsigned long)((a) - (b)) * 1000) / (unsigned long)CLOCKS_PER_SEC)

# define CLIENT_NS_FRAC_TIME_DIFF(a, b) (CLOCKS_PER_SEC <= 1000 ? 0UL \
    : (unsigned long)(CLOCKS_PER_SEC <= (clock_t)1000000UL \
        ? (((a) - (b)) * ((clock_t)1000000UL / CLOCKS_PER_SEC) % 1000) * 1000 \
        : (CLOCKS_PER_SEC <= (clock_t)1000000UL * 1000 \
            ? ((a) - (b)) * ((clock_t)1000000UL * 1000 / CLOCKS_PER_SEC) \
            : (((a) - (b)) * (clock_t)1000000UL * 1000) / CLOCKS_PER_SEC) \
          % (clock_t)1000000UL))

static void signal_gcmark(GC_EventType event)
{ 
  static clock_t start_time = 0, curr_time = 0;
  clock_t diff_time_ms = 0, diff_time_ns = 0;

  switch (event) {
    case GC_EVENT_MARK_START:
      curr_time = 0;
      start_time = clock(); 
      break;
    case GC_EVENT_MARK_END:
      curr_time = clock(); 
      diff_time_ms = CLIENT_MS_TIME_DIFF(curr_time, start_time);
      diff_time_ns = CLIENT_NS_FRAC_TIME_DIFF(curr_time, start_time);
      cum_mark_time_ms += diff_time_ms; /* may wrap */
      cum_mark_time_ns += diff_time_ns; 
      if (cum_mark_time_ns >= 1000000U) { 
        cum_mark_time_ns -= 1000000U; 
	cum_mark_time_ms++; 
      }

      /* mark-phase end */
      mark_end_no++; 
      start_time = 0; 
      break;
    default:
      break;
  }
}

#endif

#include "tree.h"
#include "tree_bench.h"



#ifndef INDEX_VEC_DEFINED
  int g_treedepths[MAX_ITERATIONS] = {0,};
#else 
  int g_treedepths[MAX_ITERATIONS] = {
   4, 7,10, 3, 1,13,14,17,17, 8, 7, 7,13,16, 4,16,
  15, 4,11,15,17,18,13,11,10,12, 9,12, 3, 1,15,17,
   6,17,17,12,16, 6,10, 9,15,15,11, 1, 5,19,16, 7,
  15,13,15, 4,16, 7,19,18, 9, 8, 4, 5,15,18, 8, 2,
   9,18,10, 6,11, 2, 6, 2,18,12,12,17,12, 3,12,19,
   4,16, 5,18,18,10, 1,12,13, 6, 5, 1,17,10,12, 2,
  15,15, 8, 9,12,14,17, 1, 8, 9,13, 1, 7, 4,13, 6,
  18, 3, 5,14,17,15, 7,12,16,15,17,15, 3, 4, 2, 5,
  11,14,16,11, 6,16,15,15,10, 9, 7, 1,14,10, 9, 4,
   6, 9,15, 4, 7,12, 3, 1,12,12, 1, 5, 1, 7,13,20,
   8, 3, 3,19,14, 6, 7, 9, 3,17,14,10,12,19, 9, 1,
  10, 3, 1, 5,17,19, 8,14,11,13,15, 8,19,10,17,17,
  17, 5,11,13,10,18, 9,13,12,12, 9,11,17, 6, 8, 5,
  11,10, 5,13, 7,15, 2,11, 2,10,11, 1, 1,19,14,11,
   3, 1, 4,17, 6,16,12, 9,11, 3,10,12, 3, 6, 8, 5,
   2,10,11,16,12,14, 7, 1,17,12,15, 9, 4, 1,15, 6,
  15,16, 4, 4, 5,17, 7,19,13,12, 4, 5, 4, 6,14, 6,
   9,18,17, 7, 3, 3,13, 7, 7,14, 2,18, 6, 7, 1,18,
  11,15, 5,13,17, 3,15, 2, 8, 6,11,18,16,16,17,10,
  15, 1,14,16,16,19,13, 9, 8,15, 5,15,16,14,13,17,
  17,10,18, 3,15,17,11,18, 9,15, 9, 6, 9, 3,16, 7,
  13, 3,11, 7,10,17,12,13, 7,10,10, 6,17,10,19, 2,
  15, 8,11, 5, 8,16, 9, 3,14, 5,18, 2,18, 1,16, 6,
   9,13,15,17,18, 1,10, 1, 1,13, 7,14, 3,19,19,18,
   8,15,16, 5, 2,11,12,12,15, 5, 6,11, 8,10,19, 3,
  15,13, 7,17, 8,18, 2, 7, 5, 8, 3,12,18, 4, 2, 3,
  12,12,14,18,16,15, 6,12,17, 3,12, 5, 3, 6,16,18,
  13,16, 3, 1, 1,14,11,12,17, 7,10, 3,11,18,11, 2,
  16, 5,12,12,18,10,15,19, 8,14, 9, 4,12, 7, 3,15,
  15, 9, 9, 9, 4,12,10, 2,16, 9,12, 9, 1, 5,17,12,
   7, 2,12, 6,10,14,10, 4,13,10, 1, 7,12,14,11,14,
  12, 5, 6, 2,16,10,10, 6, 6,14, 9,17,18,15, 8, 9,
  20, 6,16, 6,10, 8,11, 1,17,14,17, 6, 2, 5, 7,18,
  17,16,19, 9,12,16,14,17,16, 4,16, 9, 3,14,12, 2,
   5,16, 3, 7,10,16, 4,11,12,11,19,11,16,11, 7, 8,
  12, 3, 3, 2, 7,10, 1,15, 9,10, 4, 9, 9,16,19, 6,
  14, 6, 2,19,12, 1,12, 1, 3,15,12, 8, 7,11,13,17,
   4,13, 9, 8, 9,19,11, 7, 1, 8,10,10,10, 7,12,14,
  14, 9,15,11,17, 4,16, 3, 8, 9,15,18, 7, 8,16,12,
   4,18, 9, 9,18,10,17,18,18,10, 6, 3, 6, 2, 7,11,
  12,11, 2, 2, 4, 7, 8,18, 1, 7,10, 3, 4, 5, 3, 2,
  17,18,12, 7,13,15,16, 3,12, 4,16, 2,18,16, 9,10,
  14, 3, 1, 6, 6, 1,16,18, 3,12, 8, 9, 5,12,10,13,
   6, 5,15,17,11,16, 6, 9, 5, 8, 1,16, 9, 6,16, 8,
  17,10,18,16,18,11,17, 1, 7,16, 7,12, 6, 4, 5, 9,
   2,19,18, 1,18, 6,16,17,19,15,20, 9,17,16, 9, 9,
   1,15,18, 5, 4, 1,14,15,10, 3,14,16,10, 6,19, 9,
   9,12,13, 1,15,13,17, 9, 6,11,16, 8,15, 2,10, 4,
  11,17,11,16,19,19, 1,13,13, 8, 5, 9, 5, 6,15, 7,
   5,13, 4, 5, 2,13,17,18,16,17,17,18,19, 1,13,14,
   5, 8,15, 6, 6,12,16,12,11,19,13,17, 9,10,11, 8,
  11,19, 8,11, 5,20, 1,18, 6, 4, 5, 5,16, 1, 7, 7,
  14, 3,10, 2, 9, 5,18, 2,18, 3, 6, 1,19,12,13, 7,
  14,16,10, 7, 2,17,13, 9, 8,11,18,16, 7, 4,17,12,
   2,13, 3, 7, 7,15, 3, 5,11,14, 1,10, 6,12,17,15,
   2, 1,14,13, 9, 9,11,19, 4,14,19,15,10,12, 4, 3,
   6, 8,11,10,12, 9, 4,11,16,17, 3,11,18, 3, 1, 9,
  12,12,10,17, 5,17, 8, 8,12, 6,19,15, 6,16,19, 4,
  16,10,14, 8,12,15,16,13, 7, 7,18, 9,19,16,19, 3,
   7, 1, 9,17, 5, 2,17, 5, 8, 2,15,10, 8,17,18,15,
  18, 7,17, 7, 8, 9,15,18,16, 9,18,16, 9, 6,14,10,
  16,15, 7, 8, 2, 3, 9,17,14, 6,12, 1,19,19, 3,19,
  19,11,11,18, 3,14, 8, 4, 9,12,10, 7,10,19,10,16,
  13,12,18, 4, 9, 3,13, 1,15, 1,17,10, 8,12,15, 1,
  10,17,18, 8, 2, 8,10,12,10,11, 5, 2, 6,18,17,16,
   3, 3,19, 8,15,11,11,15, 1, 5,12,15,10,18, 3, 2,
   3,10,17, 9, 6, 7,15,16, 5, 7, 4,17,14, 2, 5, 3,
   8, 8, 4,11,18, 6,11,14,15,14,12, 7, 2,13,13, 2,
  12,18,14,10, 2,16,11, 7,12,10,11,19,14,17, 7,16,
  18,18,17,11,11,16, 2,15,20, 7, 2, 8, 1, 3, 8, 2,
  15, 5,18, 3, 4, 9,15,13, 4,11,12,18, 7, 9,19, 6,
  14, 8, 9, 4,16, 3,13,19, 6, 7,14,19, 7,10,11, 8,
   1,17, 8,18,12,11, 1, 6, 4,11, 7,10, 2,18,17,10,
  12,13,19,17,17,13, 7, 7,11,18,15,15,17,14,12,11,
  13, 4,17, 6, 7,10, 7,12,16, 8, 3,12, 6, 4,19, 3,
   4, 5,18,10,13,17,11, 5, 9, 9,10, 6, 9,16,14, 7,
  17, 6, 6, 3, 2,19, 9, 4, 2, 7, 9,11, 8,14, 5,13,
  12, 9,19,16, 8,10, 2, 3, 6,14,12,10, 6,15, 6,14,
   4, 7, 2,17, 5, 2, 4,18,19,14, 6,14, 2, 4,14, 3,
   1,17,14,13,17, 8,11,10, 8, 4,17, 8,11,13,12, 7,
  10,12, 1, 6, 3,17,12,12,12, 2,10, 6,11, 5, 9,16,
  19,14,10, 7, 8, 6, 1,16, 1, 4, 7, 4, 2,12,13, 4,
   5, 4, 2,18,13, 9,12,14,19,14,17, 3, 6, 3,14, 8,
   6, 3,14,12,13,16,16,17, 2,15,10, 6,15,17, 9, 6,
  19,13, 6,19,18, 6,17, 4, 8, 1,17,13,17,10, 6, 2,
  10,17,15, 3, 2, 1, 7, 3,19, 1,17, 9, 6,16, 8,14,
   3, 8, 2,13,17, 3,15, 3, 4, 6, 7,15, 4,17,14,15,
  15,14,16,19, 2,14,14,18,14,17, 8, 6, 1, 8,18, 9,
  18,18, 6, 2, 7, 9,16, 8, 6,18, 9,13, 2,13, 6, 4,
  12, 2,12,11,19,14,10,16, 7, 8, 8,12,18, 7, 3, 4,
  19, 5, 6,19, 2,18, 7, 1,16,16, 6, 6, 8, 4,11, 8,
   3, 6, 9,11, 7,10, 7, 3,18, 9, 8,14, 8, 6,17, 8,
   2, 8,11, 9,10,19,15,10, 8,10,14, 8, 9,13,19,19,
   7, 7,12, 4,12,18,14, 4, 8,10, 4, 8, 4, 9,16,13,
   6,14, 2, 7,11,12,15,13, 9, 9,17, 9, 5,19,15, 3,
  15,13,17,16,18,12,19, 8, 6, 3,12,10, 2, 4,19, 6,
   9, 9, 4,19,11, 6,11,10,12,17, 2,10, 4, 2,14, 7,
  15,13,16,18, 6, 4,16,15, 1, 8,19, 4, 2,10, 2,18,
   6,18, 8,19, 2, 1,18,10, 1, 8,16, 4,14, 9,11, 5,
   6, 7, 2,11, 3,16, 4, 5, 5, 9, 2,12,11, 3,18,15,
   4, 6, 1, 4,11,18,14,17,13,15,13,17, 2,18, 3,15,
  17,14,14, 6,10, 3,11, 1, 5,18, 1,16, 7,12, 2, 4,
   6, 3,14,11, 4,19,11, 4, 9,15,13, 7, 9,17, 9,19,
   3,19,15,17, 6,12, 8, 9,11,17, 1,10, 5,19,18, 3,
   6, 3,19, 4,18,16,19, 1,14, 4,18, 9,14,18, 4,14,
   1, 2,17,16, 9,10, 8, 9,12,10,20, 2,13,15,12, 6,
   4, 3, 9, 5,10,15, 3, 4,18, 8,13,19, 5, 2, 5, 4,
   1, 6, 8,10,18, 6,17,18,17, 4,10,14,11, 9,17, 7,
  12, 2, 1,14, 5, 3,19,18, 3,11, 2, 8, 8, 7,16, 1,
   8,10,11,14, 9,12, 8,10,13, 1,17,11, 4, 3, 6, 6,
   5, 6, 2, 6,13, 8, 4, 2,10,15,12, 7,19,13,18, 7,
   9,18,11,18, 7, 7, 1,10, 4,13, 5,18, 6, 8,12,18,
   5,14,10, 6, 6, 9,10, 3, 4, 7,16,19, 4,10,15,11,
  19,13, 5, 5,10,16, 4,14,15,17, 6, 8,10,18,16,19,
  16, 5,16, 2,13,11,15,12, 3, 4, 4, 1,20, 9,14, 2,
  11, 9, 4,16, 1,15, 8, 7,15, 8,11,11,10, 4,11, 1,
  15,13,15, 1, 8,10, 8,10, 4, 3, 7, 6, 6, 5,10,15,
   1, 7,10, 3, 1,13,14,17,17, 8, 7, 7,13,16, 4,16,
  15, 4,11,15,17,18,13,11,10,12, 9,12, 3, 1,15,17,
  15,15, 8, 9,12,14,17, 1, 8, 9,13, 1, 7, 4,13, 6,
   8, 3, 3,19,14, 6, 7, 9, 3,17,14,10,12,19, 9, 1,
   9,18,17, 7, 3, 3,13, 7, 7,14, 2,18, 6, 7, 1,18,
  11,10, 5,13, 7,15, 2,11, 2,10,11, 1, 1,19,14,11,
  11,14,16,11, 6,16,15,15,10, 9, 7, 1,14,10, 9, 4,
   3, 1, 4,17, 6,16,12, 9,11, 3,10,12, 3, 6, 8, 5,
   2,10,11,16,12,14, 7, 1,17,12,15, 9, 4, 1,15, 6,
  11,15, 5,13,17, 3,15, 2, 8, 6,11,18,16,16,17,10,
  15, 1,14,16,16,19,13, 9, 8,15, 5,15,16,14,13,17,
  17,10,18, 3,15,17,11,18, 9,15, 9, 6, 9, 3,16, 7,
   4,18, 9, 9,18,10,17,18,18,10, 6, 3, 6, 2, 7,11,
  14, 9,15,11,17, 4,16, 3, 8, 9,15,18, 7, 8,16,12,
  13, 3,11, 7,10,17,12,13, 7,10,10, 6,17,10,19, 2,
  15, 8,11, 5, 8,16, 9, 3,14, 5,18, 2,18, 1,16, 6,
   9,13,15,17,18, 1,10, 1, 1,13, 7,14, 3,19,19,18,
   7, 2,12, 6,10,14,10, 4,13,10, 1, 7,12,14,11,14,
   8,15,16, 5, 2,11,12,12,15, 5, 6,11, 8,10,19, 3,
  12,12,14,18,16,15, 6,12,17, 3,12, 5, 3, 6,16,18,
  13,16, 3, 1, 1,14,11,12,17, 7,10, 3,11,18,11, 2,
  15,16, 4, 4, 5,17, 7,19,13,12, 4, 5, 4, 6,14, 6,
  15, 9, 9, 9, 4,12,10, 2,16, 9,12, 9, 1, 5,17,12,
  12, 5, 6, 2,16,10,10, 6, 6,14, 9,17,18,15, 8, 9,
  16, 5,12,12,18,10,15,19, 8,14, 9, 4,12, 7, 3,15,
  20, 6,16, 6,10, 8,11, 1,17,14,17, 6, 2, 5, 7,18,
  17,16,19, 9,12,16,14,17,16, 4,16, 9, 3,14,12, 2,
   5,16, 3, 7,10,16, 4,11,12,11,19,11,16,11, 7, 8,
  12, 3, 3, 2, 7,10, 1,15, 9,10, 4, 9, 9,16,19, 6,
   6,17,17,12,16, 6,10, 9,15,15,11, 1, 5,19,16, 7,
  15,13,15, 4,16, 7,19,18, 9, 8, 4, 5,15,18, 8, 2,
   4,13, 9, 8, 9,19,11, 7, 1, 8,10,10,10, 7,12,14,
  17, 5,11,13,10,18, 9,13,12,12, 9,11,17, 6, 8, 5,
  18, 3, 5,14,17,15, 7,12,16,15,17,15, 3, 4, 2, 5,
   6, 9,15, 4, 7,12, 3,10,12,12, 1, 5,11, 7,13,20,
   4,16, 5,18,18,10, 1,12,13, 6, 5, 1,17,10,12, 2,
   9,18,10, 6,11, 2, 6, 2,18,12,12,17,12, 3,12,19,
  10, 3, 1, 5,17,19, 8,14,11,13,15, 8,19,10,17,17,
  14, 6, 2,19,12, 1,12, 1, 3,15,12, 8, 7,11,13,17,
  15,13, 7,17, 8,18, 2, 7, 5, 8, 3,12,18, 4, 2, 3,
  14, 3,10, 2, 9, 5,18, 2,18, 3, 6, 1,19,12,13, 7,
  19,14,10, 7, 8, 6, 1,16, 1, 4, 7, 4, 2,12,13, 4,
   5, 4, 2,18,13, 9,12,14,19,14,17, 3, 6, 3,14, 8,
  14,16,10, 7, 2,17,13, 9, 8,11,18,16, 7, 4,17,12,
   2, 1,14,13, 9, 5,11,19, 4,14,19,15,10,12, 4, 3,
  12,12,10,17, 5,17, 8, 8,12, 6,19,15, 6,16,19, 4,
   5,13, 4, 5, 2,13,17,18,16,17,17,18,19, 1,13,14,
  11,19, 8,11, 5,20, 1,18, 6, 4, 5, 5,16, 1, 7, 7,
   7, 1, 9,17, 5, 2,17, 5, 8, 2,15,10, 8,17,18,15,
  18, 7,17, 7, 8, 9,15,18,16, 9,18,16, 9, 6,14,10,
  16,15, 7, 8, 2, 3, 9,17,14, 6,12, 1,19,19, 3,19,
  19,11,11,18, 3,14, 8, 4, 9,12,10, 7,10,19,10,16,
  16,10,14, 8,12,15,16,13, 7, 7,18, 9,19,16,19, 3,
  10,17,18, 8, 2, 8,10,12,10,11, 5, 2, 6,18,17,16,
   3,10,17, 9, 6, 7,15,16, 5, 7, 4,17,14, 2, 5, 3,
  13,12,18, 4, 9, 3,13, 1,15, 1,17,10, 8,12,15, 1,
  17, 6, 6, 3, 2,19, 9, 4, 2, 7, 9,11, 8,14, 5,13,
  12, 9,19,16, 8,10, 2, 3, 6,14,12,10, 6,15, 6,14,
   1,17,14,13,17, 8,11,10, 8, 4,17, 8,11,13,12, 7,
  18,18, 6, 2, 7, 9,16, 8, 6,18, 9,13, 2,13, 6, 4,
   8, 8, 4,11,18, 6,11,14,15,14,12, 7, 2,13,13, 2,
  12,18,14,10, 2,16,11, 7,12,10,11,19,14,17, 7,16,
   3, 3,19, 8,15,11,11,15, 1, 5,12,15,10,18, 3, 2,
  18,18,17,11,11,16, 2,15,20, 7, 2, 8, 1, 3, 8, 2,
  14, 8, 9, 4,16, 3,13,19, 6, 7,14,19, 7,10,11, 8,
   1,17, 8,18,12,11, 1, 6, 4,11, 7,10, 2,18,17,10,
   4, 7, 2,17, 5, 2, 4,18,19,14, 6,14, 2, 4,14, 3,
  12,13,19,17,17,13, 7, 7,11,18,15,15,17,14,12,11,
   6, 3,14,12,13,16,16,17, 2,15,10, 6,15,17, 9, 6,
   5, 8,15, 6, 6,12,16,12,11,19,13,17, 9,10,11, 8,
  15, 5,18, 3, 4, 9,15,13, 4,11,12,18, 7, 9,19, 6,
  10,12, 1, 6, 3,17,12,12,12, 2,10, 6,11, 5, 9,16,
  10,17,15, 3, 2, 1, 7, 3,19, 1,17, 9, 6,16, 8,14,
   2,13, 3, 7, 7,15, 3, 5,11,14, 1,10, 6,12,17,15,
   6, 8,11,10,12, 9, 4,11,16,17, 3,11,18, 3, 1, 9,
  19,13, 6,19,18, 6,17, 4, 8, 1,17,13,17,10, 6, 2,
  13, 4,17, 6, 7,10, 7,12,16, 8, 3,12, 6, 4,19, 3,
   4, 5,18,10,13,17,11, 5, 9, 9,10, 6, 9,16,14, 7,
   3, 8, 2,13,17, 3,15, 3, 4, 6, 7,15, 4,17,14,15,
  15,14,16,19, 2,14,14,18,14,17, 8, 6, 1, 8,18, 9,
  10, 3, 2, 8,13,17,10,15, 5, 8,15,10, 1, 2, 8,17,
   3,18,20,16,10, 5,19, 8, 5,12, 6,16,16,14, 3,10,
  10, 5, 6, 5,11, 2,16, 3, 6, 1, 2,12, 7, 9,17,14,
  16, 3,17, 2,19,15, 8,17,15, 6, 1,14,12,17,11,12,
   2, 4, 5,16,15, 7, 1, 2,13, 8, 3, 1, 1,14,17,13,
  11,10,14,10,19,10,15, 1, 2,12,11, 7, 3, 7, 7, 6,
   9,18,14, 1,13, 9,18,14,19, 9, 4,16,10, 6,19, 9,
  11,12,15,18,16,11,18,14, 8, 4, 9,17, 6, 8,19, 7,
  13,13, 3, 1,18, 9,16,11, 7, 5,17, 1,15,14, 2,12,
   5, 4, 2,18,13, 9,12,14,19,14,17, 3, 6, 3,14, 8,
  14,16,10, 7, 2,17,13, 9, 8,11,18,16, 7, 4,17,12,
   5,13, 4, 5, 2,13,17,18,16,17,17,18,19, 1,13,14,
  11,19, 8,11, 5,20, 1,18, 6, 4, 5, 5,16, 1, 7, 7,
  15,13, 7,17, 8,18, 2, 7, 5, 8, 3,12,18, 4, 2, 3,
  14, 3,10, 2, 9, 5,18, 2,18, 3, 6, 1,19,12,13, 7,
   2, 1,14,13, 9, 9,11,19, 4,14,19,15,10,12, 4, 3,
  12,12,10,17, 5,17, 8, 8,12, 6,19,15, 6,16,19, 4,
  16,15, 7, 8, 2, 3, 9,17,14, 6,12, 1,19,19, 3,19,
  19,11,11,18, 3,14, 8, 4, 9,12,10, 7,10,19,10,16,
  16,10,14, 8,12,15,16,13, 7, 7,18, 9,19,16,19, 3,
  10,17,18, 8, 2, 8,10,12,10,11, 5, 2, 6,18,17,16,
   3,10,17, 9, 6, 7,15,16, 5, 7, 4,17,14, 2, 5, 3,
  13,12,18, 4, 9, 3,13, 1,15, 1,17,10, 8,12,15, 1,
   8, 8, 4,11,18, 6,11,14,15,14,12, 7, 2,13,13, 2,
  19,14,10, 7, 8, 6, 1,16, 1, 4, 7, 4, 2,12,13, 4,
   7, 1, 9,17, 5, 2,17, 5, 8, 2,15,10, 8,17,18,15,
  18, 7,17, 7, 8, 9,15,18,16, 9,18,16, 9, 6,14,10,
  12,18,14,10, 2,16,11, 7,12,10,11,19,14,17, 7,16,
   3, 3,19, 8,15,11,11,15, 1, 5,12,15,10,18, 3, 2,
  18,18,17,11,11,16, 2,15,20, 7, 2, 8, 1, 3, 8, 2,
  14, 8, 9, 4,16, 3,13,19, 6, 7,14,19, 7,10,11, 8,
   1,17, 8,18,12,11, 1, 6, 4,11, 7,10, 2,18,17,10,
   4, 7, 2,17, 5, 2, 4,18,19,14, 6,14, 2, 4,14, 3,
  12,13,19,17,17,13, 7, 7,11,18,15,15,17,14,12,11,
   6, 3,14,12,13,16,16,17, 2,15,10, 6,15,17, 9, 6,
  13, 4,17, 6, 7,10, 7,12,16, 8, 3,12, 6, 4,19, 3,
   4, 5,18,10,13,17,11, 5, 9, 9,10, 6, 9,16,14, 7,
   3, 8, 2,13,17, 3,15, 3, 4, 6, 7,15, 4,17,14,15,
  15,14,16,19, 2,14,14,18,14,17, 8, 6, 1, 8,18, 9,
  10, 3, 2, 8,13,17,10,15, 5, 8,15,10, 1, 2, 8,17,
   3,18,20,16,10, 5,19, 8, 5,12, 6,16,16,14, 3,10,
  10, 5, 6, 5,11, 2,16, 3, 6, 1, 2,12, 7, 9,17,14,
  16, 3,17, 2,19,15, 8,17,15, 6, 1,14,12,17,11,12,
   2, 4, 5,16,15, 7, 1, 2,13, 8, 3, 1, 1,14,17,13,
  11,10,14,10,19,10,15, 1, 2,12,11, 7, 3, 7, 7, 6,
   1,17,14,13,17, 8,11,10, 8, 4,17, 8,11,13,12, 7,
   9,18,14, 1,13, 9,18,14,19, 9, 4,16,10, 6,19, 9,
  11,12,15,18,16,11,18,14, 8, 4, 9,17, 6, 8,19, 7,
  13,13, 3, 1,18, 9,16,11, 7, 5,17, 1,15,14, 2,12,
  10,12, 1, 6, 3,17,12,12,12, 2,10, 6,11, 5, 9,16,
  17, 6, 6, 3, 2,19, 9, 4, 2, 7, 9,11, 8,14, 5,13,
  12, 9,19,16, 8,10,12,13, 6,14,12,10, 6,15, 6,14,
  18,18, 6, 2, 7, 9,16, 8, 6,18, 9,13, 2,13, 6, 4,
   5, 8,15, 6, 6,12,16,12,11,19,13,17, 9,10,11, 8,
  15, 5,18, 3, 4, 9,15,13, 4,11,12,18, 7, 9,19, 6,
  10,17,15, 3, 2, 4, 7, 3,19, 1,17, 9, 6,16, 8,14,
   2,13, 3, 7, 7,15, 3, 5,11,14, 1,10, 6,12,17,15,
   6, 8,11,10,12, 9, 4,11,16,17, 3,11,18, 3, 1, 9,
  19,13, 6,19,18, 6,17, 4, 8,11,17,13,17,10, 6, 2
};
#endif // #ifndef INDEX_VEC_DEFINED

extern Command_Line g_cmdline;
unsigned long long g_treeroots[MAX_ITERATIONS] = {0,};

int binary_tree_benchmark(Command_Line *opts)
{
  unsigned int idx, mask; 
  int check = 0, retval = 0;
  treeNode *tempTree;

  if (!opts) {
    uerror("bencmark execution options null");
    retval = -1; 
    goto err_btree_bench;
  }

#if defined(BDWGC)
  GC_INIT();
  if (!GC_get_start_callback()) {
    GC_set_start_callback(signal_gc);
    GC_start_performance_measurement();
  } else {
    udebug("[%s:%u] | GC-notify callback already set\n", __FUNCTION__, __LINE__);
  }

  if (!GC_get_on_collection_event()) { 
    GC_set_on_collection_event(signal_gcmark); 
  } else { 
    udebug("[%s:%u] | GC-notify collection event already set\n", __FUNCTION__, __LINE__);
  }
#endif

  mask = (1 << opts->retention_ratio)-1; 
  for (idx=0; idx < opts->num_iter; idx++) {
    tempTree = BottomUpTree(g_treedepths[idx]);
    check += ItemCheck(tempTree);

    /* Confuse conservative GC  */
    if (!((idx+1) & mask)) { 
      udebug("save %016lx at index %d", (uint64_t)tempTree, idx);
      g_treeroots[idx] = (uint64_t)tempTree;
    }

    /* Call tree deletion. The GC version should not delete anything */
    #ifndef BDWGC
    DeleteTree(tempTree);
    #endif 
  }
  udebug("check: %d, rand: %p", check, g_treeroots[rand() % (opts->num_iter)], sizeof(long long));

#if defined(BM_LOGFILE)
# if defined(BDWGC)
  uinfo("number of gc- cycles complete = %u, total-gc-time = %u, total-mark-time=%u.%u",
            GC_count,GC_get_full_gc_total_time(),
            cum_mark_time_ms, cum_mark_time_ns);
  uinfo("mark starts = %u, mark ends = %u", mark_start_no, mark_end_no);
  BM_Harness data = { .bm = "binary_tree",
                      .gc_cycles = GC_count,
                      .gc_time_ms = GC_get_full_gc_total_time(), 
                      .gc_marktime_ms = (cum_mark_time_ns >= 500000U) ?  cum_mark_time_ms+1: cum_mark_time_ms,
                      .retention_ratio =  1/ (float)(1 << opts->retention_ratio)
		    };
# else
  BM_Harness data = { .bm = "binary_tree",
                      .retention_ratio =  1 / (float)(1 << opts->retention_ratio), 
                      .gc_cycles = 0,
                      .gc_time_ms = 0};
# endif
  bmlog(&data);
#endif


err_btree_bench:
  return retval;
}


// tree code from
// CLBG at
// https://benchmarksgame-team.pages.debian.net/benchmarksgame/program/binarytrees-gcc-1.html
treeNode* NewTreeNode(treeNode* left, treeNode* right)
{
    treeNode*    new;

    new = (treeNode*)MYMALLOC(sizeof(treeNode));
    
    new->left = left;
    new->right = right;
    
    return new;
} /* NewTreeNode() */


treeNode* BottomUpTree(unsigned depth)
{
    if (depth > 0)
        return NewTreeNode
        (
            BottomUpTree(depth - 1),
            BottomUpTree(depth - 1)
        );
    else
        return NewTreeNode(NULL, NULL);
} /* BottomUpTree() */



long ItemCheck(treeNode* tree)
{
    if (tree->left == NULL)
        return 1;
    else
        return 1 + ItemCheck(tree->left) + ItemCheck(tree->right);
} /* ItemCheck() */



void DeleteTree(treeNode* tree)
{
    if (tree->left != NULL)
    {
        DeleteTree(tree->left);
        DeleteTree(tree->right);
    }

    FREE(tree);
} /* DeleteTree() */
